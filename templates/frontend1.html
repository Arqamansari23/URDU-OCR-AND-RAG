<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urdu Book OCR & RAG System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .card-header {
            background-color: #f1f8ff;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            padding: 1rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #868f96 0%, #596164 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(89, 97, 100, 0.4);
        }
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.75rem;
        }
        .form-control:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.25);
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        .bot-message {
            background-color: #f1f8e9;
        }
        .ocr-result {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 1rem;
        }
        .alert {
            border-radius: 10px;
        }
        .page-range-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .hidden {
            display: none;
        }
        .status-container {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
        }
        .status-message {
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .status-message:last-child {
            border-bottom: none;
        }
        .status-message.processing {
            color: #0d6efd;
        }
        .status-message.success {
            color: #198754;
        }
        .status-message.error {
            color: #dc3545;
        }
        .book-library {
            max-height: 500px;
            overflow-y: auto;
        }
        .book-item {
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        .book-item:hover {
            background-color: #e3f2fd;
            border-color: #2575fc;
            transform: translateY(-1px);
        }
        .book-item.selected {
            background-color: #e3f2fd;
            border-color: #2575fc;
            color: #2575fc;
        }
        .book-item .book-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .book-item .book-filename {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .book-item .book-date {
            font-size: 0.7rem;
            color: #adb5bd;
            margin-top: 0.25rem;
        }
        .no-books {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem 1rem;
        }
        .delete-book-btn {
            opacity: 0.7;
            transition: opacity 0.3s ease;
            padding: 0.25rem 0.5rem;
        }
        .delete-book-btn:hover {
            opacity: 1;
            background-color: #dc3545;
            color: white;
        }
        .book-info-clickable {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .book-info-clickable:hover {
            background-color: rgba(37, 117, 252, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            margin: -0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-book-open me-3"></i>Urdu Book OCR & RAG System</h1>
                    <p class="mb-0 mt-2">Extract text from Urdu books and chat with them using multilingual AI</p>
                </div>
                <div class="col-md-4 text-end">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Urdu.svg/1200px-Urdu.svg.png" alt="Urdu Script" class="img-fluid" style="max-height: 80px;">
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <!-- Upload Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload & Configure Book</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Select PDF Book</label>
                                <input class="form-control" type="file" id="pdfFile" accept=".pdf" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Page Range</label>
                                <div class="page-range-inputs">
                                    <input type="number" class="form-control" id="startPage" placeholder="Start" min="1" value="1" required>
                                    <span>to</span>
                                    <input type="number" class="form-control" id="endPage" placeholder="End" min="1" value="10" required>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="uploadIngestBtn">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Upload and Ingest Book
                                </button>
                            </div>
                        </form>
                        <div id="uploadAlert" class="alert mt-3 hidden" role="alert"></div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="card" id="statusCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Processing Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusContainer" class="status-container">
                            <p class="text-muted text-center">Status will appear here...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat with Selected Book</h5>
                        <small id="selectedBookInfo" class="text-muted">No book selected</small>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container">
                            <p class="text-muted text-center">Select a book from the library and start chatting.</p>
                        </div>
                        <div id="chatLoading" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Generating response, please wait...</p>
                        </div>
                        <form id="chatForm" class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Ask a question in English, Urdu, or Roman Urdu..." disabled>
                                <button class="btn btn-primary" type="submit" id="sendBtn" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                        <div class="mt-2 small text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Supported languages: English, Urdu (اردو), Roman Urdu
                        </div>
                    </div>
                </div>
            </div>

            <!-- Book Library Sidebar -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Book Library</h5>
                    </div>
                    <div class="card-body">
                        <div id="bookLibrary" class="book-library">
                            <p class="text-muted text-center">No books in library yet.</p>
                        </div>
                        <div id="bookLibraryLoading" class="loading-spinner">
                            <div class="spinner-border text-primary spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="d-block mt-1">Loading books...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadForm = document.getElementById('uploadForm');
            const uploadAlert = document.getElementById('uploadAlert');
            const uploadIngestBtn = document.getElementById('uploadIngestBtn');
            const chatContainer = document.getElementById('chatContainer');
            const chatLoading = document.getElementById('chatLoading');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const selectedBookInfo = document.getElementById('selectedBookInfo');

            // Status elements
            const statusCard = document.getElementById('statusCard');
            const statusContainer = document.getElementById('statusContainer');

            // Book library elements
            const bookLibrary = document.getElementById('bookLibrary');
            const bookLibraryLoading = document.getElementById('bookLibraryLoading');

            // State
            let uploadedFile = null;
            let ragConfigured = false;
            let statusInterval = null;
            let selectedBookId = null;
            let books = [];
            
            // Show alert helper
            function showAlert(element, message, type) {
                element.className = `alert alert-${type}`;
                element.textContent = message;
                element.classList.remove('hidden');
                
                // Hide after 5 seconds
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 5000);
            }
            
            // Add status message helper
            function addStatusMessage(container, message, type = 'processing') {
                const messageElement = document.createElement('div');
                messageElement.className = `status-message ${type}`;
                messageElement.textContent = message;
                container.appendChild(messageElement);
                container.scrollTop = container.scrollHeight;
            }

            // Clear status container
            function clearStatusContainer(container) {
                container.innerHTML = '<p class="text-muted text-center">Status will appear here...</p>';
            }

            // Start status polling for RAG configuration
            function startStatusPolling() {
                statusCard.style.display = 'block';
                clearStatusContainer(statusContainer);

                statusInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/get_rag_status');
                        const data = await response.json();

                        if (data.has_updates) {
                            data.status_messages.forEach(message => {
                                // Determine message type
                                let type = 'processing';
                                if (message.includes('Error') || message.includes('Failed')) {
                                    type = 'error';
                                } else if (message.includes('successfully') || message.includes('Successfully')) {
                                    type = 'success';
                                }

                                addStatusMessage(statusContainer, message, type);
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching status:', error);
                    }
                }, 1000);
            }

            // Stop status polling
            function stopStatusPolling() {
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            }

            // Delete book function
            window.deleteBook = async function(bookId, bookName) {
                if (!confirm(`Are you sure you want to delete the book "${bookName}"? This action cannot be undone.`)) {
                    return;
                }

                try {
                    console.log(`Attempting to delete book: ${bookId} - ${bookName}`);

                    const response = await fetch('/delete_book', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ book_id: bookId })
                    });

                    const data = await response.json();
                    console.log('Delete response:', data);

                    if (data.success) {
                        showAlert(uploadAlert, `Book "${bookName}" deleted successfully`, 'success');

                        // If the deleted book was selected, clear selection
                        if (selectedBookId === bookId) {
                            selectedBookId = null;
                            selectedBookInfo.textContent = 'No book selected';
                            chatInput.disabled = true;
                            sendBtn.disabled = true;
                            chatContainer.innerHTML = '<p class="text-muted text-center">Select a book from the library and start chatting.</p>';
                        }

                        // Reload books to update the library
                        loadBooks();
                    } else {
                        showAlert(uploadAlert, data.error || 'Failed to delete book', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting book:', error);
                    showAlert(uploadAlert, 'Error deleting book. Please try again.', 'danger');
                }
            }

            // Load books from library
            async function loadBooks() {
                try {
                    bookLibraryLoading.style.display = 'block';
                    bookLibrary.innerHTML = '';

                    const response = await fetch('/get_books');
                    const data = await response.json();

                    if (data.success) {
                        books = data.books;

                        if (books.length === 0) {
                            bookLibrary.innerHTML = '<p class="no-books">No books in library yet.</p>';
                        } else {
                            books.forEach(book => {
                                const bookElement = document.createElement('div');
                                bookElement.className = `book-item ${selectedBookId === book.id ? 'selected' : ''}`;
                                bookElement.dataset.bookId = book.id;

                                bookElement.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1 book-info-clickable">
                                            <div class="book-name">${book.name}</div>
                                            <div class="book-filename">${book.filename}</div>
                                            <div class="book-date">Added: ${new Date(book.created_at * 1000).toLocaleDateString()}</div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger ms-2 delete-book-btn" onclick="deleteBook('${book.id}', '${book.name}')" title="Delete Book">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;

                                // Add click handler to the book info (not the delete button)
                                const bookInfo = bookElement.querySelector('.flex-grow-1');
                                bookInfo.addEventListener('click', () => selectBook(book.id));
                                bookLibrary.appendChild(bookElement);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading books:', error);
                    bookLibrary.innerHTML = '<p class="no-books">Error loading books.</p>';
                } finally {
                    bookLibraryLoading.style.display = 'none';
                }
            }

            // Select a book
            async function selectBook(bookId) {
                try {
                    const response = await fetch('/select_book', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ book_id: bookId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        selectedBookId = bookId;
                        selectedBookInfo.textContent = `Selected: ${data.book_name}`;

                        // Update UI
                        document.querySelectorAll('.book-item').forEach(item => {
                            item.classList.toggle('selected', item.dataset.bookId === bookId);
                        });

                        // Enable chat
                        chatInput.disabled = false;
                        sendBtn.disabled = false;

                        showAlert(uploadAlert, `Selected book: ${data.book_name}`, 'success');
                    }
                } catch (error) {
                    console.error('Error selecting book:', error);
                    showAlert(uploadAlert, 'Error selecting book', 'danger');
                }
            }
            
            // Upload and Ingest form submission
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Store original button content and disable button
                const originalBtnContent = uploadIngestBtn.innerHTML;
                uploadIngestBtn.disabled = true;
                uploadIngestBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Uploading and Processing...';

                const formData = new FormData();
                const pdfFile = document.getElementById('pdfFile').files[0];
                const startPage = document.getElementById('startPage').value;
                const endPage = document.getElementById('endPage').value;

                if (!pdfFile) {
                    showAlert(uploadAlert, 'Please select a PDF file.', 'danger');
                    // Re-enable button and restore original content
                    uploadIngestBtn.disabled = false;
                    uploadIngestBtn.innerHTML = originalBtnContent;
                    return;
                }

                if (parseInt(startPage) > parseInt(endPage)) {
                    showAlert(uploadAlert, 'Start page must be less than or equal to end page.', 'danger');
                    // Re-enable button and restore original content
                    uploadIngestBtn.disabled = false;
                    uploadIngestBtn.innerHTML = originalBtnContent;
                    return;
                }

                formData.append('pdf_file', pdfFile);
                formData.append('start_page', startPage);
                formData.append('end_page', endPage);

                // Start status polling
                startStatusPolling();

                fetch('/upload_and_ingest', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Stop status polling
                    stopStatusPolling();

                    // Re-enable button and restore original content
                    uploadIngestBtn.disabled = false;
                    uploadIngestBtn.innerHTML = originalBtnContent;

                    if (data.success) {
                        showAlert(uploadAlert, `Book successfully uploaded and ingested: ${data.book_name}`, 'success');

                        // Reload books to show the new book
                        loadBooks();

                        // Clear upload form
                        uploadForm.reset();
                    } else {
                        showAlert(uploadAlert, data.error, 'danger');
                    }
                })
                .catch(error => {
                    // Stop status polling
                    stopStatusPolling();

                    // Re-enable button and restore original content
                    uploadIngestBtn.disabled = false;
                    uploadIngestBtn.innerHTML = originalBtnContent;

                    showAlert(uploadAlert, 'An error occurred while uploading and processing the book.', 'danger');
                    console.error('Error:', error);
                });
            });
            
            // Chat form submission
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const query = chatInput.value.trim();
                if (!query || !selectedBookId) return;

                // Add user message to chat
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-message user-message';
                userMessage.textContent = query;
                chatContainer.appendChild(userMessage);

                // Clear input
                chatInput.value = '';

                // Show loading
                chatLoading.style.display = 'block';
                chatContainer.scrollTop = chatContainer.scrollHeight;

                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        book_id: selectedBookId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    chatLoading.style.display = 'none';

                    if (data.success) {
                        // Add bot message to chat
                        const botMessage = document.createElement('div');
                        botMessage.className = 'chat-message bot-message';
                        botMessage.textContent = data.response;
                        chatContainer.appendChild(botMessage);
                    } else {
                        // Add error message
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'chat-message bot-message text-danger';
                        errorMessage.textContent = `Error: ${data.error}`;
                        chatContainer.appendChild(errorMessage);
                    }

                    chatContainer.scrollTop = chatContainer.scrollHeight;
                })
                .catch(error => {
                    chatLoading.style.display = 'none';

                    // Add error message
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bot-message text-danger';
                    errorMessage.textContent = 'An error occurred while generating a response.';
                    chatContainer.appendChild(errorMessage);

                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    console.error('Error:', error);
                });
            });

            // Load books on page load
            loadBooks();
        });
    </script>
</body>
</html>